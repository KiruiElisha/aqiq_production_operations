[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-23 16:40:56.530433",
  "module": "AQIQ Production operations",
  "name": "Job Card",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Card",
  "script": "\ndoc.employee = ''",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-24 11:13:25.096818",
  "module": "AQIQ Production operations",
  "name": "Job Card Employee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Card Time Log",
  "script": "doc.employee = \"\"",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-06 05:27:26.449696",
  "module": "AQIQ Production operations",
  "name": "Job card Custom",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Card",
  "script": "def create_material_request(doc):\n    if not doc.items:\n        return\n\n    work_order = frappe.db.get_value(\"Work Order\", doc.name, 'name')\n\n    # Check for existing Material Requests\n    existing_mrs = frappe.get_all(\"Material Request\", \n                                  filters={\n                                      \"job_card\": doc.name,\n                                      \"docstatus\": [\"<\", 2]  # 0: Draft, 1: Submitted, <2: Not Cancelled\n                                  },\n                                  fields=[\"name\"])\n\n    if existing_mrs:\n        # Compare existing MRs with current requirements\n        total_requested = get_total_requested_qty(existing_mrs, doc.items)\n        \n        if all(item.required_qty <= total_requested.get(item.item_code, 0) for item in doc.items):\n            # frappe.msgprint(\"Sufficient materials already requested for this Job Card.\")\n            return\n\n    # Create new Material Request for additional quantities\n    material_request = frappe.new_doc(\"Material Request\")\n    material_request.update({\n        \"material_request_type\": \"Material Transfer\",\n        \"company\": doc.company,\n        \"transaction_date\": doc.posting_date,\n        \"job_card\": doc.name,\n        \"work_order\": work_order\n    })\n\n    items_added = False\n    for item in doc.items:\n        additional_qty = max(0, item.required_qty - total_requested.get(item.item_code, 0))\n        if additional_qty > 0:\n            material_request.append(\"items\", {\n                \"item_code\": item.item_code,\n                \"qty\": additional_qty,\n                \"stock_uom\": item.stock_uom,\n                \"schedule_date\": doc.expected_start_date,\n                \"warehouse\": item.wip_warehouse,\n                \"job_card\": doc.name,\n                \"from_warehouse\": item.source_warehouse,\n                \"work_order\": work_order\n            })\n            items_added = True\n\n    if items_added:\n        material_request.insert()\n        material_request.submit()\n        frappe.msgprint(f\"Additional Material Request {material_request.name} created and submitted.\")\n    else:\n        frappe.msgprint(\"No additional materials required; Material Request not created.\")\n\ndef get_total_requested_qty(existing_mrs, items):\n    total_requested = {}\n    for mr in existing_mrs:\n        mr_items = frappe.get_all(\"Material Request Item\",\n                                  filters={\"parent\": mr.name},\n                                  fields=[\"item_code\", \"qty\"])\n        for item in mr_items:\n            total_requested[item.item_code] = total_requested.get(item.item_code, 0) + item.qty\n    return total_requested\n\ncreate_material_request(doc)",
  "script_type": "DocType Event"
 }
]